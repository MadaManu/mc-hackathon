var client = require("./_client-helper"),
	assert = require('assert'),
	restify = require('restify');

describe('Webhook -', function() {

	it('should create a webhook successfully', function(done) {
		client.webhook.create({
			url: "https://www.simplifycommerce.com/simplifyendpoint"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			assert.equal(data.url, "https://www.simplifycommerce.com/simplifyendpoint", "Create a new Webhook should succeed");
			done();
		});
	});

	it('should delete a webhook successfully', function(done) {
		client.webhook.create({
			url: "https://www.simplifycommerce.com/simplifyendpoint"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			// Use id of newly created webhook to execute 'delete' request
			client.webhook.delete(data.id, function(deleteError, deleteData) {

				if (deleteError) {
					console.error(JSON.stringify(deleteError.data));
					done(deleteError);
				}

				assert.equal(deleteData.id.toString(), data.id.toString(), "Deletion of Webhook with ID '" + data.id + "' should succeed");
				done();
			});
		});
	});

	it('should retrieve a list of webhooks successfully', function(done) {
		client.webhook.list({
			max: 30
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			assert.equal(data.max.toString(), '30', "List Webhook succeeds.");
			done();
		});
	});

	it('should find a webhook successfully', function(done) {
		client.webhook.create({
			url: "https://www.simplifycommerce.com/simplifyendpoint"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			// Use id of newly created webhook to execute 'find' request
			client.webhook.find(data.id, function(findError, findData) {

				if (findError) {
					console.error(JSON.stringify(findError.data));
					done(findError);
				}

				assert.equal(findData.id.toString(), data.id.toString(), "Find Webhook with ID '" + data.id + "' should succeed");
				done();
			});
		});
	});

	it('update a webhook successfully', function(done) {
		client.webhook.create({
			url: "https://www.simplifycommerce.com/simplifyendpoint"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			client.webhook.update({
				id: data.id,
				url: "http://0.0.0.0:10080/webhook"
			}, function(updateError, updateData) {

				if (updateError) {
					console.error(JSON.stringify(updateError.data));
					done(updateError);
				}

				assert.equal(updateData.url, "http://0.0.0.0:10080/webhook", "Update Webhook with ID '" + data.id + "' should succeed");
				done();
			});
		});
	});

	it('should decode a transmitted webhook successfully', function(done) {
		// Function to handle the webhook event
		function respond(req, res, next) {
			client.event.create({
				payload: req.body,
				url: 'http://0.0.0.0:10080/webhook'
			}, function(error, data) {

				if (error) {
					console.error(JSON.stringify(error.data));
					done(error);
				}

				assert.equal(data.event.name, "payment.create", "Decdode Webhook should succeed successfully");
				done();
			});
		}

		// Create & start our server with our webhook endpoint
		var server = restify.createServer();
		server.use(restify.urlEncodedBodyParser());
		server.post('/webhook', respond);
		server.listen(10080);

		// Fire a Webhook event
		client.payment.create({
			amount: "6666",
			description: "Fire a Webhook payment",
			card: {
				expMonth: "11",
				expYear: "19",
				cvc: "123",
				number: "5555555555554444"
			},
			currency: "USD"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			assert.equal(data.paymentStatus, "APPROVED", "Create Payment fails with correct error code.");
		});
	});

});