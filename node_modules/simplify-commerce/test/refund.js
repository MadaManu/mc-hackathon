var client = require("./_client-helper"),
	assert = require('assert');

describe('Refund -', function() {

	it('should create a refund successfully', function(done) {
		client.payment.create({
			amount: "123123",
			description: "payment description",
			card: {
				expMonth: "11",
				expYear: "19",
				cvc: "123",
				number: "5555555555554444"
			},
			currency: "USD"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			client.refund.create({
				amount: "1",
				payment: data.id,
				reason: "Refund Description"
			}, function(createError, createData) {

				if (createError) {
					console.error(JSON.stringify(createError.data));
					done(createError);
				}

				assert.equal(createData.description, "Refund Description", "Create Refund should succeed");
				done();
			});
		});
	});

	it('should retrieve a list of refunds successfully', function(done) {
		client.refund.list({
			max: 30
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			assert.equal(data.max.toString(), '30', "List Refund succeeds.");
			done();
		});
	});

	it('should find a refund successfully', function(done) {
		client.payment.create({
			amount: "123123",
			description: "payment description",
			card: {
				expMonth: "11",
				expYear: "19",
				cvc: "123",
				number: "5555555555554444"
			},
			currency: "USD"
		}, function(error, data) {

			if (error) {
				console.error(JSON.stringify(error.data));
				done(error);
			}

			client.refund.create({
				amount: "1",
				payment: data.id,
				reason: "Refund Description"
			}, function(createError, createData) {

				if (createError) {
					console.error(JSON.stringify(createError.data));
					done(createError);
				}

				// Use id of newly created refund to execute 'find' request
				client.refund.find(createData.id, function(findError, findData) {

					if (findError) {
						console.error(JSON.stringify(findError.data));
						done(findError);
					}

					assert.equal(findData.id.toString(), createData.id.toString(), "Find Refund of ID '" + data.id + "'' should succeed");
					done();
				});
			});
		});
	});

});